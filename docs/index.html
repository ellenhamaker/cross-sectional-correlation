<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ellen Hamaker" />


<title>The Curious Case of the Cross-Sectional Correlation – Supplementary Materials</title>

<script src="site_libs/header-attrs-2.16/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"> </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">The Curious Case of the Cross-Sectional
Correlation – Supplementary Materials</h1>
<h4 class="author">Ellen Hamaker</h4>
<h4 class="date">September, 2022</h4>

</div>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This serves as supporting materials to the manuscript entitled “The
Curious Case of the Cross-Sectional Correlation”, which I wrote for the
special issue of Multivariate Behavioral Research in honor of Peter
Molenaar’s work.</p>
<p>Peter Molenaar showed that when ergodicity is absent–meaning that
individuals are characterized by different means, variances,
covariances, et cetera–the results obtained from cross-sectional data
will not adequately reflect the patterns that exist at the individual
level.</p>
<p>Researchers inspired by Molenaar’s work have considered how the
cross-sectional correlation is related to the correlation of a single
individual, which I refer to as the person-specific correlation. How
these two correlations are related, is explained and illustrated with
several numerical examples below. The outline is as follows:</p>
<ul>
<li><p>An intuitive presentation of the two correlations of
interest</p></li>
<li><p>General set up of the simulations, including the introduction of
other correlations and quantities that are needed to connect the
cross-sectional correlation to the person-specific correlation</p></li>
<li><p>Examples based on specific constellations of parameter values,
and simulated data from which specific correlations of interest are
estimated</p></li>
</ul>
</div>
<div id="two-correlations-of-interest" class="section level1">
<h1>Two correlations of interest</h1>
<p>To get an initial understanding of the difference between the
cross-sectional correlation and the person-specific correlation, it is
helpful to make use of Cattell’s databox. Cattell’s databox shows that
there are three dimensions in which we can sample: variables, persons,
and time points.</p>
<p>Here we will consider only the latter two dimensions, while keeping
the variables fixed: These are referred to as <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>. The databox then can be visualized
as</p>
<div class="figure">
<img src="CattellDatabox1.jpg" style="width:60.0%" alt="" />
<p class="caption"><em>Fig.1: Cattell’s databox for two variables <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span></em></p>
</div>
<p>When considering <strong>cross-sectional data</strong>, we obtain a
horizontal slice from this databox, consisting of one occasion and many
persons, which can be visualized as</p>
<div class="figure">
<img src="CattellDatabox2.jpg" style="width:60.0%" alt="" />
<p class="caption"><em>Fig.2: Cross-sectional data represented as a
slice from Cattell’s databox</em></p>
</div>
<p>When consider <strong>single subject (<span
class="math inline">\(N=1\)</span>)</strong> data, we obtain a slice in
the vertical direction, which can be visualized as</p>
<div class="figure">
<img src="CattellDatabox3.jpg" style="width:60.0%" alt="" />
<p class="caption"><em>Fig.3: Single subject (<span
class="math inline">\(N=1\)</span>) data represented as a slice from
Cattell’s databox</em></p>
</div>
<p>When looking at the databox in this way, it is not difficult to
imagine that different individuals may be characterized by different
person-specific correlations. Hence, in general the person-specific
correlation will not be identical to the cross-sectional
correlation.</p>
<p>In the paper, I show how the following expression for the
cross-sectional correlation can be derived:</p>
<p><span class="math display">\[ \rho = \eta_{BX}\eta_{BY}\rho_B +
\eta_{WX}\eta_{WY}\rho_W\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(\eta^2_{BX}\)</span> is the
intraclass correlation of <span class="math inline">\(X\)</span>
(proportion of stable differences between persons in X)</p></li>
<li><p><span class="math inline">\(\eta^2_{BY}\)</span> is the
intraclass correlation of <span class="math inline">\(Y\)</span>
(proportion of stable differences between persons in Y)</p></li>
<li><p><span class="math inline">\(\rho_B\)</span> is the between-person
correlation (correlation of person-specific means)</p></li>
<li><p><span class="math inline">\(\eta^2_{WX} = 1 -
\eta^2_{BX}\)</span> is the proportion of variance of <span
class="math inline">\(X\)</span> not due to stable differences between
persons)</p></li>
<li><p><span class="math inline">\(\eta^2_{WY} = 1 -
\eta^2_{BY}\)</span> the proportion of variance of <span
class="math inline">\(Y\)</span> not due to stable differences between
persons)</p></li>
<li><p><span class="math inline">\(\rho_W\)</span> is the within-person
correlation (correlation across people of temporal deviation from
person-specific means)</p></li>
</ul>
</div>
<div id="two-curiosities" class="section level1">
<h1>Two curiosities</h1>
<p>The expression for the cross-sectional correlation is well known in
certain parts of the scientific literature. However, despite the simple
appearance of this expression, there are two curiosities associated with
it that I present in the paper.</p>
<p>The <strong>first curiosity</strong> is concerned with the difference
between the within-person correlation, which is part of the expression
for the cross-sectional correlation given above, and the average
person-specific correlation, which is what we are interested in based on
Cattell’s databox, that is,</p>
<p><span class="math display">\[\rho_W =
\frac{E[cov(X,Y|P)]}{\sqrt{E[var(X|P)]}]\sqrt{E[var(Y|P)]}} \;\;\;\;\;
\mathrm{versus} \;\;\;\;\;\;\;\kappa = E\Biggl[
\frac{cov(X,Y|P)}{\sqrt{var(X|P)}\sqrt{var(Y|P)}}\Biggr].\]</span></p>
<p>These two correlations are only the same under specific circumstances
(such as ergodicity).</p>
<p>The <strong>second curiosity</strong> has to do with the weights in
the expression for the cross-sectional correlation given above. Unless
the intraclass correlations are the same for <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>, these two weights do not add up to
one. Specifically, <span class="math display">\[0 \leq
\eta_{BX}\eta_{BY} + \eta_{WX}\eta_{WY} \leq 1.\]</span> As a result of
this, the cross-sectional correlation <span
class="math inline">\(\rho\)</span> does not necessarily lie in between
the between-person correlation <span
class="math inline">\(\rho_B\)</span> and the within-person correlation
<span class="math inline">\(\rho_W\)</span>, but may lie closer to zero
than both of them.</p>
</div>
<div id="general-approach" class="section level1">
<h1>General approach</h1>
<p>In the paper, seven examples are given that illustrate how these two
curiosities combined may affect the results. The examples are based on
chosing certain values for some of the parameters, and using analytical
results presented in the paper to compute the other parameters. In
addition, data are simulated from which an estimate of the
cross-sectional correlation is obtained. A file only containing the
R-code that is used below can be found <a
href="https://github.com/ellenhamaker/cross-sectional-correlation/blob/main/RcodeCorrelation.R">here</a>.</p>
<p>To create heterogeneity in the population with respect to the
within-person distribution, a scenario is used in which the total
population consists of two subpopulations that both make up exactly half
of the population. In this scenario, we only have to specify two sets of
parameters for the within-person part (i.e., two values for the
person-specific covariance, and two values for the person-specific
variances). The mean differences between persons will come from a
multivariate normal distribution.</p>
<div id="step-1" class="section level2">
<h2>Step 1</h2>
<p>First, we have to <strong>choose values</strong> for the following
parameters</p>
<ul>
<li><p><span class="math inline">\(cov(X|P)\)</span> – the
person-specific covariance</p></li>
<li><p><span class="math inline">\(var(X|P)\)</span> and <span
class="math inline">\(var(Y|P)\)</span> – the person-specific
variances</p></li>
</ul>
<p>Withe these, we can simulate the within-person components per
person.</p>
<p>Additionally, we can use these parameter to <strong>compute
values</strong> for the following parameters</p>
<ul>
<li><p><span class="math inline">\(\kappa_p\)</span> – the
person-specific correlation</p></li>
<li><p><span class="math inline">\(\kappa\)</span> – the average
person-specific correlation</p></li>
<li><p><span class="math inline">\(\sigma_{XY}\)</span> – the average
person-specific covariance</p></li>
<li><p><span class="math inline">\(\sigma^2_{X}\)</span> and <span
class="math inline">\(\sigma^2_{Y}\)</span> – the average
person-specific variances</p></li>
<li><p><span class="math inline">\(\rho_W\)</span> – the within-person
correlation</p></li>
</ul>
</div>
<div id="step-2" class="section level2">
<h2>Step 2</h2>
<p>Second, we need to choose and compute the parameters that defined the
between-person level. Here we <strong>choose values</strong> for the
following parameters</p>
<ul>
<li><p><span class="math inline">\(\eta_{BX}^2\)</span> and <span
class="math inline">\(\eta_{BY}^2\)</span> – the intraclass correlations
of <span class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span></p></li>
<li><p><span class="math inline">\(\rho_B\)</span> – the between-person
correlation</p></li>
</ul>
<p>Based on these we can <strong>compute values</strong> for the
following parameters</p>
<ul>
<li><p><span class="math inline">\(\sigma_{BX}^2\)</span> and <span
class="math inline">\(\sigma_{BY}^2\)</span> – the between-person
variances of <span class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span></p></li>
<li><p><span class="math inline">\(\sigma_{BX, BY}\)</span> – the
between-person covariance</p></li>
</ul>
<p>With these values, we can simulate the between-person components per
person.</p>
<p>In addition, we can now <strong>compute the value</strong> of</p>
<ul>
<li><span class="math inline">\(\rho\)</span> – the cross-sectional
correlation</li>
</ul>
<p>Note that, instead of choosing the intraclass correlations and
between-person correlation, we could also have chosen the between-person
variances and covariance, and computed the others from them. This would
work equally well; the current approach is chosen, simply because it
allows for more direct control over (and tinkering ease of) the
contributions of the various components that are needed in the
expression for the cross-sectional correlation.</p>
</div>
</div>
<div id="example-1" class="section level1">
<h1>Example 1</h1>
<p>In this first example from the paper, I will elaborate a bit more on
the details in each of the steps. The example is based on individuals
having different person-specific variances, but the same person-specific
covariance; as a result they have different person-specific
correlations. The between-person correlation is set to be equal to the
average person-specific correlation. The intraclass correlations will be
somewhat different, but not extremely different.</p>
<div id="analytical-part" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-1" class="section level3">
<h3>Step 1</h3>
<p>In the first example in the paper we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in all individuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">1.25 in half of the individuals; 5 in the other
half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(1.25,1,1,1.25),2,2)
cov.mat2 &lt;- matrix(c(5,1,1,5),2,2)</code></pre>
<p>Based on this we can compute:</p>
<ul>
<li>the person-specific correlation in the first half of the
population:</li>
</ul>
<p><span class="math display">\[\kappa_p =
\frac{cov(X,Y|P)}{\sqrt{var(X|P)}\sqrt{var(Y|P)}}=\frac{1}{1.25} =
0.8\]</span></p>
<ul>
<li>the person-specific correlation in the other half of the
population:</li>
</ul>
<p><span class="math display">\[\kappa_p =
\frac{cov(X,Y|P)}{\sqrt{var(X|P)}\sqrt{var(Y|P)}} = \frac{1}{5} =
0.2\]</span></p>
<p>Fromt these we can compute the average person-specific
correlation:</p>
<p><span class="math display">\[\kappa =
E\Biggl[\frac{cov(X,Y|P)}{\sqrt{var(X|P)}\sqrt{var(Y|P)}}\Biggr]=
\frac{0.8+0.2}{2} = 0.5\]</span></p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>We can also compute:</p>
<ul>
<li><p>the average person-specific covariance: <span
class="math display">\[\sigma_{XY} = E[cov(X,Y|P)] = \frac{1+1}{2} =
1\]</span></p></li>
<li><p>the average person-specific variances: <span
class="math display">\[\sigma_{X}^2 = E[var(X|P)] = \frac{1.25+5}{2} =
3.125 \;\;\;\;\;\; \mathrm{and} \;\;\;\;\;\; \sigma_{Y}^2 = E[var(Y|P)]
= \frac{1.25+5}{2} = 3.125\]</span></p></li>
</ul>
<p>From these we can compute the correlation of within-person
deviations: <span class="math display">\[\rho_W =
\frac{\sigma_{XY}}{\sigma_{X}\sigma_{Y}} = \frac{1}{3.125} =
0.32\]</span></p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-1" class="section level3">
<h3>Step 2</h3>
<p>In the second step we add the between strucuture; this implies we
will have individual differences in the person-specific means <span
class="math inline">\(E(X|P)\)</span> and <span
class="math inline">\(E(Y|P)\)</span>. We could do this by simply
specifying the covariance and variances of these mean differences (i.e.,
<span class="math inline">\(\sigma_{BX,BY}\)</span>, <span
class="math inline">\(\sigma_{BX}^2\)</span>, and <span
class="math inline">\(\sigma_{BY}^2\)</span>); from these we could
determine the intraclass correlations <span
class="math inline">\(\eta_{BX}^2\)</span> and <span
class="math inline">\(\eta_{BY}^2\)</span>, and the between-person
correlation <span class="math inline">\(\rho_B\)</span>, which all three
are used in the expression for the cross-sectional correlation presented
above.</p>
<p>To allow for more informed decisions when choosing the parameters
that define the between-person level, we do it the other way around.
Hence we specify the intraclass correlations and by using the average
within-person variances obtained above, we can compute the
between-person variances from these. That is, we know <span
class="math display">\[ \eta^2_{BX} =
\frac{\sigma_{BX}^2}{\sigma_X^2}=\frac{\sigma_{BX}^2}{\sigma_{BX}^2+\sigma_{WX}^2}.\]</span>
Frm this, we can get an expression of the between-person variance as a
funciton of the intraclass correlation and the average within-person
correlation, through <span
class="math display">\[\eta^2_{BX}\bigl(\sigma_{BX}^2+\sigma_{WX}^2\bigr)
=\eta^2_{BX}\sigma_{BX}^2+\eta^2_{BX}\sigma_{WX}^2 =
\sigma_{BX}^2\]</span> and thus <span
class="math display">\[\eta^2_{BX}\sigma_{WX}^2 = \sigma_{BX}^2 -
\eta^2_{BX}\sigma_{BX}^2 = \bigl( 1 -
\eta^2_{BX}\bigr)\sigma_{BX}^2\]</span> so that <span
class="math display">\[\sigma_{BX}^2 = \frac{\eta^2_{BX}\sigma_{WX}^2}{1
- \eta^2_{BX}}\]</span></p>
<p>For the between-person variance of <span
class="math inline">\(Y\)</span> we can use the average within-person
variance of <span class="math inline">\(Y\)</span> and the intraclass
correlation that we specify for <span
class="math inline">\(Y\)</span>.</p>
<p>Once we have the between-person variances and we have chosen a value
for the between-person correlation, we can also get the between-person
covariance; this is not needed to compute what the cross-sectional
correlation will be, but it is needed if we want to simulate data.</p>
<p>IN the first exaple in the paper, I choose:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.4</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.5</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">0.5</td>
</tr>
</tbody>
</table>
<p>Note that the between-person correlation is chosen to be identical to
the average person-specific correlation (i.e., <span
class="math inline">\(\kappa = \rho_B\)</span>, but we could have chosen
any other value between -1 and 1.</p>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0.5
icc.X &lt;- 0.4
icc.Y &lt;- 0.5</code></pre>
<p>From these values, we can compute:</p>
<ul>
<li><p>the between-person variance on <span
class="math inline">\(X\)</span>: <span
class="math display">\[var(E[X|P]) = \sigma_{BX}^2 =
\frac{1-\eta^2_{BX}}{\eta^2_{BX}\sigma_{WX}^2} = \frac{0.4*3.125}{1-0.4}
= 2.083\]</span></p></li>
<li><p>the between-person variance on <span
class="math inline">\(Y\)</span>: <span
class="math display">\[var(E[Y|P]) = \sigma_{BY}^2 =
\frac{1-\eta^2_{BY}}{\eta^2_{BY}\sigma_{WY}^2} = \frac{0.5*3.125}{1-0.5}
= 3.125\]</span></p></li>
<li><p>the between-person covariance: <span
class="math display">\[cov(E[X,Y|P]) = \sigma_{BX}\sigma_{BY}\rho_B =
\sqrt{2.083}\sqrt{3.125}*0.5 = 1.276\]</span></p></li>
</ul>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 2.083333</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 3.125</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 1.275776</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:
<span class="math display">\[ \rho = \eta_{BX}\eta_{BY}\rho_B +
\eta_{WX}\eta_{WY}\rho_W = \sqrt{0.4}*\sqrt{0.5}*0.5 +
\sqrt{0.5}*\sqrt{0.4}*0.32 = 0.399  \]</span></p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.398878</code></pre>
</div>
</div>
<div id="simulate-data" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data. For this, we have to decide how many persons and how many time
points we want. We also need to load the package mvtnorm, to sample from
a multivariate normal distribution. To make our results reproducable, we
set a seed.</p>
<pre class="r"><code>library(mvtnorm)

set.seed(8427)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<p>We thus have <span class="math display">\[ \begin{bmatrix} E[X|P] \\
E[Y|P] \end{bmatrix}
\sim MVN \Biggl(\begin{bmatrix} 0\\0\end{bmatrix},
\begin{bmatrix} \sigma_{BX}^2 \\
\sigma_{BX,BY} &amp; \sigma_{BY}^2\end{bmatrix} \Biggr)\]</span></p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##          [,1]     [,2]
## [1,] 2.080003 1.275760
## [2,] 1.275760 3.003354</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.5104272
## [2,] 0.5104272 1.0000000</code></pre>
</div>
<div id="simulate-wp-components" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p><span class="math display">\[ \begin{bmatrix} X_{pt} \\ Y_{pt}
\end{bmatrix}
\sim MVN \Biggl(\begin{bmatrix} E[X|P] \\ E[Y|P] \end{bmatrix} ,
\begin{bmatrix} var(X|P) \\
cov(X,Y|P) &amp; var(Y|P)\end{bmatrix} \Biggr)\]</span></p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.500293</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.500293</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.5091679
## [2,] 0.5091679 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.3202297</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.4025841</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.3925434</code></pre>
</div>
</div>
<div id="example-2" class="section level1">
<h1>Example 2</h1>
<p>The second example uses the same parameter values as the first,
except for the intraclass correlations.</p>
<div id="analytical-part-1" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-2" class="section level3">
<h3>Step 1</h3>
<p>As in the first example in the paper we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in all individuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">1.25 in half of the individuals; 5 in the other
half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(1.25,1,1,1.25),2,2)
cov.mat2 &lt;- matrix(c(5,1,1,5),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-2" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.1</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.9</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">0.5</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0.5
icc.X &lt;- 0.1
icc.Y &lt;- 0.9</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 0.3472222</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 28.125</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 1.5625</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.246</code></pre>
</div>
</div>
<div id="simulate-data-1" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(3482)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-1" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 0.3559804  1.490122
## [2,] 1.4901223 26.686277</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4834648
## [2,] 0.4834648 1.0000000</code></pre>
</div>
<div id="simulate-wp-components-1" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-1" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5005293</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13b-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5005293</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4801566
## [2,] 0.4801566 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.3207922</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.2445103</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17b-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17b-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.2287784</code></pre>
</div>
</div>
<div id="example-3" class="section level1">
<h1>Example 3</h1>
<p>The second third example, individuals have different person-specific
covariances, while the person-specific variances are the same for
everyone.</p>
<div id="analytical-part-2" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-3" class="section level3">
<h3>Step 1</h3>
<p>In the third example in the paper we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">4 in half of the population; 5 in the other half</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">10 in all individuals in the population</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(10,5,5,10),2,2)
cov.mat2 &lt;- matrix(c(10,4,4,10),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.45</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.45</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-3" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.2</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.8</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">0.5</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0.45
icc.X &lt;- 0.2
icc.Y &lt;- 0.8</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 2.5</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 40</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 4.5</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.36</code></pre>
</div>
</div>
<div id="simulate-data-2" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(4497)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-2" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##          [,1]      [,2]
## [1,] 2.607862  4.516259
## [2,] 4.516259 40.821997</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4377129
## [2,] 0.4377129 1.0000000</code></pre>
</div>
<div id="simulate-wp-components-2" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-2" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.449642</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.45</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13c-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.449642</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.45</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4383838
## [2,] 0.4383838 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0.45</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.449612</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.3563899</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17c-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17c-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.353743</code></pre>
</div>
</div>
<div id="example-4" class="section level1">
<h1>Example 4</h1>
<p>The fourth example is based on a scenario in which individuals have
different person-specific variances and covariances, but their
person-specific correlation is the same, that is <span
class="math inline">\(\kappa_p=\kappa\)</span>.</p>
<div id="analytical-part-3" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-4" class="section level3">
<h3>Step 1</h3>
<p>In this example we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in half of the population; 5 in the other half</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">2 in half of the population; 10 in the other half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(2,1,1,2),2,2)
cov.mat2 &lt;- matrix(c(10,5,5,10),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-4" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.2</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.8</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">0.5</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0.5
icc.X &lt;- 0.2
icc.Y &lt;- 0.8</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 1.5</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 24</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 3</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.4</code></pre>
</div>
</div>
<div id="simulate-data-3" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(9517)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-3" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##          [,1]      [,2]
## [1,] 1.497167  3.009598
## [2,] 3.009598 25.209829</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4898785
## [2,] 0.4898785 1.0000000</code></pre>
</div>
<div id="simulate-wp-components-3" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-3" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5002624</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13d-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5002624</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.4898753
## [2,] 0.4898753 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.5003565</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.3933235</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17d-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17d-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.4077072</code></pre>
</div>
</div>
<div id="example-5" class="section level1">
<h1>Example 5</h1>
<p>The fifth example is based on a scenario in which individuals have
the same person-specific means; hence, there is no between-person
structure, and the intraclass correlations are both 0.</p>
<div id="analytical-part-4" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-5" class="section level3">
<h3>Step 1</h3>
<p>In the fifth example in the paper we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in all individuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">1.25 in half of the population; 5 in the other
half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(1.25,1,1,1.25),2,2)
cov.mat2 &lt;- matrix(c(5,1,1,5),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-5" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">N/A</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0
icc.X &lt;- 0
icc.Y &lt;- 0</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.32</code></pre>
</div>
</div>
<div id="simulate-data-4" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(5276)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-4" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##      [,1] [,2]
## [1,]    0    0
## [2,]    0    0</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>## Warning in cor(means.XY): the standard deviation is zero</code></pre>
<pre><code>##      [,1] [,2]
## [1,]    1   NA
## [2,]   NA    1</code></pre>
</div>
<div id="simulate-wp-components-4" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-4" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.4987048</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13e-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.4987048</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.2985834
## [2,] 0.2985834 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.3184196</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.3184023</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17e-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17e-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.3403943</code></pre>
</div>
</div>
<div id="example-6" class="section level1">
<h1>Example 6</h1>
<p>The final example is similar to the first example, but now the
between-person correlation is set to zero.</p>
<div id="analytical-part-5" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-6" class="section level3">
<h3>Step 1</h3>
<p>In this example we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in all individuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">1.25 in half of the population; 5 in the other
half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(1.25,1,1,1.25),2,2)
cov.mat2 &lt;- matrix(c(5,1,1,5),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-6" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.4</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.5</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left">0</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- 0
icc.X &lt;- 0.4
icc.Y &lt;- 0.5</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 2.083333</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 3.125</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.1752712</code></pre>
</div>
</div>
<div id="simulate-data-5" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(7517)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-5" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##             [,1]        [,2]
## [1,] 2.193835195 0.001250731
## [2,] 0.001250731 3.321605421</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##              [,1]         [,2]
## [1,] 1.0000000000 0.0004633275
## [2,] 0.0004633275 1.0000000000</code></pre>
</div>
<div id="simulate-wp-components-5" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-5" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5011832</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13f-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.5011832</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##             [,1]        [,2]
## [1,] 1.000000000 0.002026074
## [2,] 0.002026074 1.000000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.3222364</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.1725406</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17f-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17f-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.1676793</code></pre>
</div>
</div>
<div id="example-7" class="section level1">
<h1>Example 7</h1>
<p>The within part of the final example is the same as that of Examples
1, 2, 5, and 6. The between-person correlation is equal to the
within-person correlation here, and the intraclass correlations are
equal to each other.</p>
<div id="analytical-part-6" class="section level2">
<h2>Analytical part</h2>
<div id="step-1-7" class="section level3">
<h3>Step 1</h3>
<p>In this example we have:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(cov(X,Y|P)\)</span></td>
<td align="left">1 in all individuals</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(var(X|P)\)</span></td>
<td align="left">1.25 in half of the population; 5 in the other
half</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(var(Y|P)\)</span></td>
<td align="left">identical to <span
class="math inline">\(var(X|P)\)</span></td>
</tr>
</tbody>
</table>
<p>Including these in matrices, we get:</p>
<pre class="r"><code># Specify two person-specific covariance matrices for two subpopulations
cov.mat1 &lt;- matrix(c(1.25,1,1,1.25),2,2)
cov.mat2 &lt;- matrix(c(5,1,1,5),2,2)</code></pre>
<p>From these we compute:</p>
<pre class="r"><code># The average person-specific correlation can be determined
kappa1 &lt;- cov.mat1[2,1]/(sqrt(cov.mat1[1,1])*sqrt(cov.mat1[2,2]))
kappa2 &lt;- cov.mat2[2,1]/(sqrt(cov.mat2[1,1])*sqrt(cov.mat2[2,2]))
kappa &lt;- (kappa1+kappa2)/2
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>as well as:</p>
<pre class="r"><code># Determine the average person-specific variances and covariance
var.wX &lt;- (cov.mat1[1,1] + cov.mat2[1,1])/2
var.wY &lt;- (cov.mat1[2,2] + cov.mat2[2,2])/2
cov.wXwY &lt;- (cov.mat1[2,1]+cov.mat2[2,1])/2

# From these the within-person correlation can be computed:
rhoW &lt;- cov.wXwY/(sqrt(var.wX)*sqrt(var.wY))
rhoW</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>This already shows that <span class="math inline">\(\kappa \neq
\rho_W\)</span>, that is, the average person-specific correlation is not
(always) the same as the within-person correlation <span
class="math inline">\(\rho_W\)</span> from the expression for the
cross-lagged correlation.</p>
</div>
<div id="step-2-7" class="section level3">
<h3>Step 2</h3>
<p>For the between part we use the following values:</p>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\eta^2_{BX}\)</span></td>
<td align="left">0.4</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\eta^2_{BY}\)</span></td>
<td align="left">0.4</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\rho_B\)</span></td>
<td align="left"><span class="math inline">\(\rho_W\)</span></td>
</tr>
</tbody>
</table>
<pre class="r"><code># Specify the correlation at the between-person level
# and choose the intraclass correlations for X and Y
rhoB &lt;- rhoW
icc.X &lt;- 0.4
icc.Y &lt;- 0.4</code></pre>
<p>From these values, we can compute:</p>
<pre class="r"><code># Compute the between-person variances based on the icc&#39;s and the average 
# person-specific variances
var.bX &lt;- icc.X*var.wX/(1-icc.X)
var.bX</code></pre>
<pre><code>## [1] 2.083333</code></pre>
<pre class="r"><code>var.bY &lt;- icc.Y*var.wY/(1-icc.Y)
var.bY</code></pre>
<pre><code>## [1] 2.083333</code></pre>
<pre class="r"><code># Compute the between-person covariance based on the between-person correlation
# and the between-person variances
cov.bXbY &lt;- rhoB*sqrt(var.bX)*sqrt(var.bY)
cov.bXbY</code></pre>
<pre><code>## [1] 0.6666667</code></pre>
<pre class="r"><code># Place these values in a covariance matrix
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)</code></pre>
<p>Now we can compute the value for the cross-sectional correlation:</p>
<pre class="r"><code># Compute the cross-sectional correlation
rho &lt;- sqrt(icc.X)*sqrt(icc.Y)*rhoB + sqrt(1-icc.X)*sqrt(1-icc.Y)*rhoW
rho</code></pre>
<pre><code>## [1] 0.32</code></pre>
</div>
</div>
<div id="simulate-data-6" class="section level2">
<h2>Simulate data</h2>
<p>Based on the parameter values defined above, we can now simulate
data.</p>
<pre class="r"><code>set.seed(3962)

# Total sample size
N &lt;- 1000   # number pf persons
TP &lt;- 1000   # number of time points</code></pre>
<div id="simulate-bp-components-6" class="section level3">
<h3>Simulate BP components</h3>
<p>We start with simulating the person-specific means using the
covariance and variances from the between-person components. We set the
grand means to zero in this simulations.</p>
<pre class="r"><code># Place the between-person covariance and variances in a matrix, and use this
# to simulate the person-specific means (between-person components)
cov.mat.B &lt;- matrix(c(var.bX,cov.bXbY,cov.bXbY,var.bY),2,2)
means.XY &lt;- rmvnorm(N,mean = c(0,0),sigma = cov.mat.B)
cov(means.XY) </code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 2.0762572 0.6391896
## [2,] 0.6391896 2.0517630</code></pre>
<pre class="r"><code>cor(means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.3096888
## [2,] 0.3096888 1.0000000</code></pre>
</div>
<div id="simulate-wp-components-6" class="section level3">
<h3>Simulate WP components</h3>
<p>Here, we simulate the within-person components, and add the
between-person component right away to get the actual scores. We do this
per person using</p>
<p>We start with creating matrices to save the scores on <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span>; these can be thought of as slices from
Cattell’s databox.</p>
<pre class="r"><code># Create two matrices to contain the scores on X and Y 
# for TP repeated measures (rows) and for N persons (columns)
X &lt;- matrix(,TP,N)
Y &lt;- matrix(,TP,N)</code></pre>
<p>Next, we sample values for individuals from both subpopulations</p>
<pre class="r"><code># Create data for the first subpopulation
for (i in 1:(N/2))
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat1)
  X[,i] &lt;- Z[,1] 
  Y[,i] &lt;- Z[,2]
}

# Create data fro the second subpopulation
for (i in ((N/2)+1):N)
{ Z &lt;- rmvnorm(TP, mean = means.XY[i,], sigma = cov.mat2)
  X[,i] &lt;- Z[,1]
  Y[,i] &lt;- Z[,2]
}</code></pre>
</div>
</div>
<div id="analyze-data-6" class="section level2">
<h2>Analyze data</h2>
<p>Now that we have the data, we can analyze them in various ways.
First, we will estimated the means per person and their correlation
<span class="math inline">\(\kappa_p\)</span>.To this end we need to
create matrices that can contain these quantities</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
hat.means.XY &lt;- matrix(,N,2)
hat.kappa.p &lt;- matrix(,N,1)</code></pre>
<p>To obtain the estimated person-specific means and correlation, we
make use of</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (p in 1:N)
{ Xp &lt;- X[,p]
  Yp &lt;- Y[,p]
  hat.means.XY[p,] &lt;- c(mean(Xp),mean(Yp))
  hat.kappa.p[p,1] &lt;- cor(Xp,Yp)
}
# Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.4991716</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<pre class="r"><code># Histogram
hist(hat.kappa.p, breaks=100, xlim=c(0,1))</code></pre>
<p><img src="index_files/figure-html/block13g-1.png" width="672" /></p>
<p>Now we can estimate the average person-specific correlation</p>
<pre class="r"><code># Average person-specific correlation:
mean(hat.kappa.p)</code></pre>
<pre><code>## [1] 0.4991716</code></pre>
<pre class="r"><code># Compare to true value:
kappa</code></pre>
<pre><code>## [1] 0.5</code></pre>
<p>and the between-person correlation</p>
<pre class="r"><code># Between-person correlation 
cor(hat.means.XY)</code></pre>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.3112025
## [2,] 0.3112025 1.0000000</code></pre>
<pre class="r"><code># Compare to true value:
rhoB</code></pre>
<pre><code>## [1] 0.32</code></pre>
<p>We can also estimate the within-person correlation <span
class="math inline">\(\rho_W\)</span> and the cross-sectional
correlation <span class="math inline">\(\rho\)</span>; this can be done
for every time point separately. We therefore start with making matrices
to contain these</p>
<pre class="r"><code># Create matrices to contain estimates of the within-person correlation 
# and the cross-sectional correlation
hat.rhoW &lt;- matrix(,TP,1)
hat.rho &lt;- matrix(,TP,1)</code></pre>
<p>Next, for every time point, we compute the within-person component
(using the estimated person means), and determine the correlation of
these across individuals (i.e., an estimate of <span
class="math inline">\(\rho_W\)</span>), and we estimate the
cross-sectional correlation (i.e., <span
class="math inline">\(\rho\)</span>):</p>
<pre class="r"><code># Create matrices to contain estimates of the person-specific 
# means and correlations for N persons
for (t in 1:TP)
{ Xt &lt;- X[t,]
  Yt &lt;- Y[t,]
  WXt &lt;- X[t,] - hat.means.XY[,1]
  WYt &lt;- Y[t,] - hat.means.XY[,2]
  hat.rhoW[t,] &lt;- cor(WXt,WYt)
  hat.rho[t,] &lt;- cor(Xt,Yt)
}
# Average person-specific correlation:
mean(hat.rhoW)</code></pre>
<pre><code>## [1] 0.3191652</code></pre>
<pre class="r"><code>mean(hat.rho)</code></pre>
<pre><code>## [1] 0.3159522</code></pre>
<pre class="r"><code>hist(hat.rhoW, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated WP correlation for TP occasions&quot;)
abline(v=rhoW, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17g-1.png" width="672" /></p>
<pre class="r"><code>hist(hat.rho, breaks=20, xlim=c(0,1), 
     main=&quot;Estimated cross-sectional correlation for TP occasions&quot;)
abline(v=rho, col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="index_files/figure-html/block17g-2.png" width="672" /></p>
<p>The estimated cross-sectional correlation for the first wave is</p>
<pre class="r"><code># Cross-sectional correlation for the first wave (reported in the paper)
hat.rho[1,1]</code></pre>
<pre><code>## [1] 0.3166116</code></pre>
</div>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>The seven examples considered above can be summarized as follows:</p>
<table>
<thead>
<tr class="header">
<th align="left">Example</th>
<th align="left">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left"><span class="math inline">\(\rho_W &lt; \rho &lt;\rho_B
= \kappa\)</span></td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left"><span class="math inline">\(\rho &lt; \rho_W &lt;\rho_B
= \kappa\)</span></td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left"><span class="math inline">\(\rho &lt; \rho_W =\rho_B =
\kappa\)</span></td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left"><span class="math inline">\(\rho &lt; \rho_W &lt;\rho_B
= \kappa = \kappa_p\)</span></td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left"><span class="math inline">\(\rho = \rho_W &lt;
\kappa\)</span> and <span class="math inline">\(\rho_B\)</span> does not
exist</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left"><span class="math inline">\(\rho_B &lt; \rho &lt;
\rho_W &lt; \kappa\)</span></td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="left"><span class="math inline">\(\rho = \rho_W = \rho_B &lt;
\kappa\)</span></td>
</tr>
</tbody>
</table>
<hr />
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4,h5",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
